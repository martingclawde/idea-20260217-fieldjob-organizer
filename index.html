<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FieldJob Organizer — MVP</title>
  <meta name="description" content="MVP: organizar trabajos de campo (side hustles) para no perder horarios ni olvidarse follow-ups." />
  <style>
    :root{
      --bg:#0b0b0c;--panel:#101012;--panel2:#0f0f11;--border:#25252a;--txt:#e7e7ea;--muted:#a7a7b3;
      --ok:#52d39c;--warn:#ffcc66;--bad:#ff6b6b;--link:#7aa2f7;--chip:#17171b;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--txt)}
    a{color:var(--link)}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    h1{margin:0 0 8px 0;font-size:28px}
    .sub{color:var(--muted);margin:0 0 18px 0;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.15fr 0.85fr;gap:14px}
    @media (max-width: 940px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .card h2{margin:0 0 12px 0;font-size:16px;color:#f0f0f5}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 580px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;background:var(--panel2);border:1px solid var(--border);color:var(--txt);padding:10px 10px;border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#3a3a44}
    textarea{min-height:64px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{background:#1b1b21;border:1px solid #2b2b33;color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:#2a3150;border-color:#3a4a86}
    button.danger{background:#411b1f;border-color:#6a2b33}
    button:hover{filter:brightness(1.08)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .pill b{color:var(--txt)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    .kpi .pill{flex:0 0 auto}
    .status{margin-top:12px;padding:10px;border-radius:12px;border:1px solid var(--border);background:#0f0f13}
    .status.ok{border-color:#24483a;background:#0e1612}
    .status.warn{border-color:#5a4b20;background:#15120a}
    .status.bad{border-color:#5a2020;background:#160c0c}
    .list{display:flex;flex-direction:column;gap:10px}
    .job{border:1px solid var(--border);background:#0f0f13;border-radius:14px;padding:12px}
    .jobTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .jobTitle{font-weight:650}
    .jobMeta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
    .jobActions{display:flex;gap:8px}
    .tag{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#14141a;color:var(--muted)}
    .tag.ok{border-color:#1f4a38;color:var(--ok)}
    .tag.warn{border-color:#5a4b20;color:var(--warn)}
    .tag.bad{border-color:#5a2020;color:var(--bad)}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .small{color:var(--muted);font-size:12px;line-height:1.4}
    code{background:#141418;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FieldJob Organizer (MVP)</h1>
    <p class="sub">
      Para side hustles tipo “dump trailer / junk removal / deliveries / service calls”.
      Objetivo: que no se te mezclen horarios, recordatorios y cierres (landfill/depósito) entre llamadas/WhatsApps/notas.
      <br />
      Guarda todo en tu navegador (<b>localStorage</b>). Cero login. Cero backend.
    </p>

    <div class="grid">
      <div class="card">
        <h2>1) Cargar trabajo</h2>
        <div class="row">
          <div>
            <label>Cliente</label>
            <input id="client" placeholder="Ej: Juan Pérez" />
          </div>
          <div>
            <label>Teléfono / WhatsApp (opcional)</label>
            <input id="phone" placeholder="Ej: +45 12 34 56 78" />
          </div>
        </div>

        <label>Dirección (opcional)</label>
        <input id="address" placeholder="Ej: Calle 123, Ciudad" />

        <div class="row">
          <div>
            <label>Fecha</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Hora de llegada</label>
            <input id="arrival" type="time" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Duración estimada (min)</label>
            <input id="duration" type="number" min="5" step="5" value="45" />
          </div>
          <div>
            <label>Buffer / transición (min)</label>
            <input id="buffer" type="number" min="0" step="5" value="15" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>¿Vas al landfill / depósito?</label>
            <select id="needsDump">
              <option value="yes" selected>Sí</option>
              <option value="no">No</option>
            </select>
          </div>
          <div>
            <label>Hora de cierre (landfill)</label>
            <input id="close" type="time" value="17:00" />
          </div>
        </div>

        <label>Notas</label>
        <textarea id="notes" placeholder="Cosas importantes: portón, piso, cash, llaves, etc."></textarea>

        <div class="btns">
          <button class="primary" id="addBtn">Agregar</button>
          <button id="clearFormBtn">Limpiar</button>
        </div>

        <div class="hr"></div>

        <h2>2) Chequeo rápido</h2>
        <div id="status" class="status">Completá fecha/hora para ver un chequeo automático.</div>
        <div class="kpi" id="kpis"></div>
        <p class="small">
          Heurística simple: <code>salida = llegada + duración + buffer</code>. Si <code>salida</code> es después del cierre, te avisa.
          No hace routing ni tráfico todavía (eso vendría en v0.2).
        </p>
      </div>

      <div class="card">
        <h2>Agenda</h2>
        <div class="btns">
          <button id="exportBtn">Copiar agenda (texto)</button>
          <button class="danger" id="wipeBtn">Borrar todo</button>
        </div>
        <p class="small">Tip: pegalo en WhatsApp/Telegram para tener el plan del día fijo arriba.</p>

        <div class="hr"></div>

        <div id="list" class="list"></div>
      </div>
    </div>

    <div class="hr"></div>
    <p class="small">
      Idea basada en dolores reales leídos hoy en Reddit (ej: “me pierdo entre llamadas/WhatsApp/notas y ya pifié horarios”).
      Repo: <a href="https://github.com/martingclawde/idea-20260217-fieldjob-organizer">github.com/martingclawde/idea-20260217-fieldjob-organizer</a>
    </p>
  </div>

<script>
  const LS_KEY = 'fjo_jobs_v1';

  const $ = (id) => document.getElementById(id);
  const elClient = $('client');
  const elPhone = $('phone');
  const elAddress = $('address');
  const elDate = $('date');
  const elArrival = $('arrival');
  const elDuration = $('duration');
  const elBuffer = $('buffer');
  const elNeedsDump = $('needsDump');
  const elClose = $('close');
  const elNotes = $('notes');
  const elStatus = $('status');
  const elKpis = $('kpis');
  const elList = $('list');

  function pad2(n){ return String(n).padStart(2,'0'); }

  function parseTimeToMinutes(t){
    if(!t) return null;
    const [hh,mm] = t.split(':').map(Number);
    if(Number.isNaN(hh)||Number.isNaN(mm)) return null;
    return hh*60+mm;
  }

  function minutesToTime(m){
    m = ((m%1440)+1440)%1440;
    const hh = Math.floor(m/60);
    const mm = m%60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }

  function addMinutes(t, delta){
    const base = parseTimeToMinutes(t);
    if(base === null) return null;
    return minutesToTime(base + delta);
  }

  function loadJobs(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }

  function saveJobs(jobs){
    localStorage.setItem(LS_KEY, JSON.stringify(jobs));
  }

  function computeJobHealth(job){
    const arrivalM = parseTimeToMinutes(job.arrival);
    const closeM = parseTimeToMinutes(job.close);
    if(arrivalM === null) return {level:'warn', label:'Falta hora', detail:''};

    const duration = Number(job.durationMin||0);
    const buffer = Number(job.bufferMin||0);
    const doneTime = minutesToTime(arrivalM + duration + buffer);

    if(job.needsDump !== 'yes'){
      return {level:'ok', label:'OK', detail:`Salida estimada ${doneTime}`};
    }

    if(closeM === null){
      return {level:'warn', label:'Sin cierre', detail:`Salida estimada ${doneTime}`};
    }

    if(arrivalM + duration + buffer > closeM){
      return {level:'bad', label:'Riesgo', detail:`Salida ${doneTime} > cierre ${job.close}`};
    }

    const slack = closeM - (arrivalM + duration + buffer);
    if(slack <= 30){
      return {level:'warn', label:'Justo', detail:`Slack ${slack}m (salida ${doneTime}, cierre ${job.close})`};
    }

    return {level:'ok', label:'OK', detail:`Slack ${slack}m (salida ${doneTime}, cierre ${job.close})`};
  }

  function renderList(){
    const jobs = loadJobs().sort((a,b) => (a.date+a.arrival).localeCompare(b.date+b.arrival));
    elList.innerHTML = '';

    if(jobs.length === 0){
      elList.innerHTML = `<div class="small">No hay trabajos todavía. Agregá el primero a la izquierda.</div>`;
      return;
    }

    for(const job of jobs){
      const h = computeJobHealth(job);
      const tagClass = h.level;
      const title = job.client?.trim() ? job.client.trim() : '(sin cliente)';
      const addr = job.address?.trim();
      const when = `${job.date || '(sin fecha)'} ${job.arrival || ''}`.trim();

      const div = document.createElement('div');
      div.className = 'job';
      div.innerHTML = `
        <div class="jobTop">
          <div>
            <div class="jobTitle">${escapeHtml(title)} <span class="tag ${tagClass}">${escapeHtml(h.label)}</span></div>
            <div class="jobMeta">
              <div><b>Cuando:</b> ${escapeHtml(when)}</div>
              ${addr ? `<div><b>Dirección:</b> ${escapeHtml(addr)}</div>` : ''}
              ${job.phone ? `<div><b>Contacto:</b> ${escapeHtml(job.phone)}</div>` : ''}
              <div><b>Plan:</b> ${escapeHtml(h.detail || '')}</div>
              ${job.notes ? `<div><b>Notas:</b> ${escapeHtml(job.notes)}</div>` : ''}
            </div>
          </div>
          <div class="jobActions">
            <button data-act="copy" data-id="${job.id}">Copiar</button>
            <button class="danger" data-act="del" data-id="${job.id}">Borrar</button>
          </div>
        </div>
      `;

      div.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const act = btn.getAttribute('data-act');
          const id = btn.getAttribute('data-id');
          if(act === 'del') deleteJob(id);
          if(act === 'copy') copyJobText(id);
        });
      });

      elList.appendChild(div);
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function clearForm(){
    elClient.value=''; elPhone.value=''; elAddress.value='';
    elDate.value=''; elArrival.value='';
    elDuration.value='45'; elBuffer.value='15';
    elNeedsDump.value='yes'; elClose.value='17:00';
    elNotes.value='';
    updateStatus();
  }

  function updateStatus(){
    elKpis.innerHTML = '';
    const arrival = elArrival.value;
    const durationMin = Number(elDuration.value||0);
    const bufferMin = Number(elBuffer.value||0);
    const needsDump = elNeedsDump.value;
    const close = elClose.value;

    const arrivalM = parseTimeToMinutes(arrival);
    if(arrivalM === null){
      elStatus.className = 'status';
      elStatus.textContent = 'Completá fecha/hora para ver un chequeo automático.';
      return;
    }

    const out = minutesToTime(arrivalM + durationMin + bufferMin);
    const closeM = parseTimeToMinutes(close);

    // KPI pills
    const pill = (label, value) => {
      const d = document.createElement('div');
      d.className='pill';
      d.innerHTML = `${escapeHtml(label)} <b>${escapeHtml(value)}</b>`;
      elKpis.appendChild(d);
    };

    pill('Salida est.', out);
    pill('Duración', `${durationMin}m`);
    pill('Buffer', `${bufferMin}m`);

    if(needsDump !== 'yes'){
      elStatus.className='status ok';
      elStatus.textContent = `OK: no marcaste landfill. Salida estimada ${out}.`;
      return;
    }

    if(closeM === null){
      elStatus.className='status warn';
      elStatus.textContent = `Ojo: marcaste landfill pero falta hora de cierre. Salida estimada ${out}.`;
      return;
    }

    const slack = closeM - (arrivalM + durationMin + bufferMin);
    pill('Slack', `${slack}m`);

    if(slack < 0){
      elStatus.className='status bad';
      elStatus.textContent = `Riesgo: con esta estimación salís ${out} y el landfill cierra ${close}.`;
    }else if(slack <= 30){
      elStatus.className='status warn';
      elStatus.textContent = `Justo: salís ${out} y el landfill cierra ${close}. Te quedan ${slack} minutos.`;
    }else{
      elStatus.className='status ok';
      elStatus.textContent = `OK: salís ${out}, cierre ${close} (slack ${slack}m).`;
    }
  }

  function addJob(){
    const job = {
      id: crypto.randomUUID(),
      client: elClient.value.trim(),
      phone: elPhone.value.trim(),
      address: elAddress.value.trim(),
      date: elDate.value,
      arrival: elArrival.value,
      durationMin: Number(elDuration.value||0),
      bufferMin: Number(elBuffer.value||0),
      needsDump: elNeedsDump.value,
      close: elClose.value,
      notes: elNotes.value.trim(),
      createdAt: new Date().toISOString(),
    };

    const jobs = loadJobs();
    jobs.push(job);
    saveJobs(jobs);
    renderList();

    // UX: mantener la fecha si estás cargando varios del mismo día
    elClient.value=''; elPhone.value=''; elAddress.value=''; elArrival.value=''; elNotes.value='';
    elClient.focus();
  }

  function deleteJob(id){
    const jobs = loadJobs().filter(j => j.id !== id);
    saveJobs(jobs);
    renderList();
  }

  function jobToText(job){
    const h = computeJobHealth(job);
    const parts = [];
    parts.push(`• ${job.date || '(sin fecha)'} ${job.arrival || ''} — ${job.client || '(sin cliente)'} [${h.label}]`);
    if(job.address) parts.push(`  - Dir: ${job.address}`);
    if(job.phone) parts.push(`  - Contacto: ${job.phone}`);
    parts.push(`  - Dur: ${job.durationMin}m + buffer ${job.bufferMin}m | landfill: ${job.needsDump === 'yes' ? 'sí' : 'no'} | cierre: ${job.close || 'n/a'}`);
    if(h.detail) parts.push(`  - Check: ${h.detail}`);
    if(job.notes) parts.push(`  - Notas: ${job.notes}`);
    return parts.join('\n');
  }

  async function copyJobText(id){
    const job = loadJobs().find(j => j.id === id);
    if(!job) return;
    await navigator.clipboard.writeText(jobToText(job));
  }

  async function exportAgenda(){
    const jobs = loadJobs().sort((a,b) => (a.date+a.arrival).localeCompare(b.date+b.arrival));
    const lines = [];
    lines.push('AGENDA (FieldJob Organizer)');
    lines.push('');
    for(const job of jobs){
      lines.push(jobToText(job));
      lines.push('');
    }
    lines.push('---');
    lines.push('MVP local (sin login).');
    const text = lines.join('\n');
    await navigator.clipboard.writeText(text);
  }

  function wipeAll(){
    if(!confirm('¿Seguro? Esto borra todos los trabajos guardados en este navegador.')) return;
    localStorage.removeItem(LS_KEY);
    renderList();
  }

  // Wire events
  ['input','change'].forEach(evt => {
    [elDate, elArrival, elDuration, elBuffer, elNeedsDump, elClose].forEach(el => {
      el.addEventListener(evt, updateStatus);
    });
  });

  $('addBtn').addEventListener('click', () => {
    if(!elDate.value || !elArrival.value){
      alert('Poné fecha y hora de llegada (mínimo).');
      return;
    }
    addJob();
  });
  $('clearFormBtn').addEventListener('click', clearForm);
  $('exportBtn').addEventListener('click', exportAgenda);
  $('wipeBtn').addEventListener('click', wipeAll);

  // Init
  updateStatus();
  renderList();
</script>
</body>
</html>
